#!/bin/bash
#SBATCH --job-name=AIND-Ephys-Pipeline
#SBATCH --output={{ log_directory }}/job-%j_slurm.log
#SBATCH --mem=16GB
#SBATCH --partition=mit_normal
#SBATCH --time=12:00:00

NWB_FILE_PATH="{{ nwb_file_path }}"
DATA_PATH="$(dirname "$NWB_FILE_PATH")"

RESULTS_PATH="{{ results_directory }}"
WORKDIR="{{ work_directory }}"
NXF_APPTAINER_CACHEDIR="{{ apptainer_cache_directory }}"

source /etc/profile.d/modules.sh
module load miniforge

conda activate {{ environment_directory }}

DATA_PATH="$DATA_PATH" RESULTS_PATH="$RESULTS_PATH" NXF_APPTAINER_CACHEDIR="$NXF_APPTAINER_CACHEDIR" nextflow \
    -C "{{ config_file_path }}" \
    -log "{{ log_directory }}/nextflow.log" \
    run "{{ pipeline_file_path }}" \
    -work-dir "$WORKDIR" \
    --job_dispatch_args "--input nwb --nwb-files $NWB_FILE_PATH" \
    --nwb_ecephys_args "--backend hdf5"

cd $RESULTS_PATH
# TODO: move various items into places
# TODO: copy capsule_version.env file into code for provenance
# TODO: remove need for extra flags
dandi upload --allow-any-path --validation skip
rm -rf {{ temporary_processing_directory }}
