params.executor = "slurm"

params.default_queue = 'mit_normal'
params.gpu_queue = 'mit_normal_gpu'

// Runtimes are defined by https://orcd-docs.mit.edu/running-jobs/overview/#partitions
params.max_normal_runtime_in_minutes = 12*60
params.max_gpu_runtime_in_minutes = 6*60

/*
* Calculate time with optional multiplier/divisor and min/max constraints.
* @param multiplier Factor to multiply max_duration_minutes by (default: 1)
* @param divisor Factor to divide max_duration_minutes by (default: 1)
* @param minMinutes Minimum allowed minutes (default: 0)
* @param maxMinutes Maximum allowed minutes
* @return Closure that computes time string (e.g., "120m")
*/
def calcTime = { max_duration_minutes, multiplier = 1, divisor = 1, min_minutes = 0, max_minutes ->
    {
        def calculated = max_duration_minutes * multiplier / divisor
        def constrained = Math.max(calculated, min_minutes)
        Math.min(constrained, max_minutes) + 'm'
    }
}

apptainer {
    enabled = true
    autoMounts = true
    apptainer.enabled = true
    apptainer.autoMounts = true
    platform = 'linux/amd64'
    envWhitelist = ['KACHERY_ZONE', 'KACHERY_API_KEY', 'NUMBA_CACHE_DIR', 'HDF5_USE_FILE_LOCKING', 'HF_HOME']
}

process {
    executor = 'slurm'
    queue = params.default_queue
    debug = true

    containerOptions = "--bind \$HOME:\$HOME,/orcd/data/dandi/001:/orcd/data/dandi/001"

    withName: job_dispatch {
        cpus=4
        memory='16 GB'
        time='1h'
    }
    withName: preprocessing {
        cpus=32
        memory='256 GB'
        time=calcTime(max_duration_minutes.toFloat(), 4, 1, 0, params.max_normal_runtime_in_minutes)
    }
    withName: spikesort_kilosort4 {
        cpus=16
        memory='64 GB'
        containerOptions='--nv'
        clusterOptions='--gres=gpu:1'
        queue=params.gpu_queue ?: params.default_queue
        time=calcTime(max_duration_minutes.toFloat(), 4, 1, 0, params.max_gpu_runtime_in_minutes)
    }
    withName: spikesort_kilosort25 {
        cpus=16
        memory='64 GB'
        containerOptions='--nv'
        clusterOptions='--gres=gpu:1'
        queue=params.gpu_queue ?: params.default_queue
        time=calcTime(max_duration_minutes.toFloat(), 4, 1, 0, params.max_gpu_runtime_in_minutes)
    }
    withName: spikesort_spykingcircus2 {
        cpus=16
        memory='64 GB'
        time=calcTime(max_duration_minutes.toFloat(), 4, 1, 0, params.max_normal_runtime_in_minutes)
    }
    withName: postprocessing {
        cpus=16
        memory='64 GB'
        time=calcTime(max_duration_minutes.toFloat(), 4, 1, 0, params.max_normal_runtime_in_minutes)
    }
    withName: curation {
        cpus=4
        memory='32 GB'
        time=calcTime(max_duration_minutes.toFloat(), 1, 6, 10, params.max_normal_runtime_in_minutes)
    }
    withName: visualization {
        cpus=4
        memory='32 GB'
        time=calcTime(max_duration_minutes.toFloat(), 2, 1, 0, params.max_normal_runtime_in_minutes)
    }
    withName: results_collector {
        cpus=4
        memory='32 GB'
        time=calcTime(max_duration_minutes.toFloat(), 1, 1, 10, params.max_normal_runtime_in_minutes)
    }
    withName: quality_control {
        cpus=16
        memory='64 GB'
        time=calcTime(max_duration_minutes.toFloat(), 2, 1, 0, params.max_normal_runtime_in_minutes)
    }
    withName: quality_control_collector {
        cpus=4
        memory='32 GB'
        time=calcTime(max_duration_minutes.toFloat(), 1, 6, 10, params.max_normal_runtime_in_minutes)
    }
    withName: nwb_subject {
        cpus=4
        memory='32 GB'
        time=calcTime(max_duration_minutes.toFloat(), 1, 6, 10, params.max_normal_runtime_in_minutes)
    }
    withName: nwb_ecephys {
        cpus=16
        memory='64 GB'
        time=calcTime(max_duration_minutes.toFloat(), 2, 1, 0, params.max_normal_runtime_in_minutes)
    }
    withName: nwb_units {
        cpus=4
        memory='32 GB'
        time=calcTime(max_duration_minutes.toFloat(), 2, 1, 0, params.max_normal_runtime_in_minutes)
    }
}


dag {
    enabled = true
    file = RESULTS_PATH + '/nextflow/dag.html'
    overwrite = true
}

report {
    enabled = true
    file = RESULTS_PATH + '/nextflow/report.html'
    overwrite = true
}

timeline {
    enabled = true
    file = RESULTS_PATH + '/nextflow/timeline.html'
    overwrite = true
}

trace {
    enabled = true
    file = RESULTS_PATH + '/nextflow/trace.txt'
    overwrite = true
}
